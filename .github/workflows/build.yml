name: æ„å»ºå’Œæ‰“åŒ…

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      build_windows:
        description: 'æ„å»º Windows ç‰ˆæœ¬'
        required: false
        default: 'true'
        type: boolean
      build_macos:
        description: 'æ„å»º macOS ç‰ˆæœ¬'
        required: false
        default: 'true'
        type: boolean
      build_linux:
        description: 'æ„å»º Linux ç‰ˆæœ¬'
        required: false
        default: 'false'
        type: boolean
  pull_request:
    branches:
      - main
      - master

jobs:
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            python-version: '3.11'
            name: linux
            artifact_name: auto-login-linux-amd64
          - os: windows-latest
            python-version: '3.11'
            name: windows
            artifact_name: auto-login-windows-amd64.exe
          - os: macos-latest
            python-version: '3.11'
            name: macos
            artifact_name: auto-login-macos-amd64

    runs-on: ${{ matrix.os }}
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'pull_request') ||
      (github.event_name == 'workflow_dispatch' && (
        (matrix.name == 'windows' && (github.event.inputs.build_windows != 'false')) ||
        (matrix.name == 'macos' && (github.event.inputs.build_macos != 'false')) ||
        (matrix.name == 'linux' && github.event.inputs.build_linux == 'true')
      ))
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr libtesseract-dev

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install tesseract

      - name: å®‰è£…ç³»ç»Ÿä¾èµ– (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          choco install tesseract -y || echo "Chocolatey æœªå®‰è£…ï¼Œè·³è¿‡ Tesseract å®‰è£…"

      - name: å®‰è£… Python ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: |
          playwright install chromium
          playwright install-deps chromium

      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          Write-Host "æ­£åœ¨æ„å»º Windows å¯æ‰§è¡Œæ–‡ä»¶..."
          pyinstaller --name=auto-login --onefile --console --clean --noconfirm --strip `
            --hidden-import=playwright.sync_api `
            --hidden-import=pytesseract `
            --hidden-import=PIL `
            --hidden-import=config `
            --hidden-import=browser_manager `
            --hidden-import=lock_manager `
            --hidden-import=ocr_engine `
            --exclude-module=matplotlib `
            --exclude-module=numpy `
            --exclude-module=pandas `
            --exclude-module=tkinter `
            main.py
          
          Write-Host "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå®Œæˆ"

      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (macOS)
        if: matrix.os == 'macos-latest'
        shell: bash
        run: |
          echo "æ­£åœ¨æ„å»º macOS å¯æ‰§è¡Œæ–‡ä»¶..."
          pyinstaller --name=auto-login --onefile --console --clean --noconfirm --strip \
            --hidden-import=playwright.sync_api \
            --hidden-import=pytesseract \
            --hidden-import=PIL \
            --hidden-import=config \
            --hidden-import=browser_manager \
            --hidden-import=lock_manager \
            --hidden-import=ocr_engine \
            --exclude-module=matplotlib \
            --exclude-module=numpy \
            --exclude-module=pandas \
            --exclude-module=tkinter \
            main.py
          
          echo "âœ… macOS å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå®Œæˆ"
          
          # åˆ›å»º macOS .app åŒ…ï¼ˆå¯é€‰ï¼Œä½¿åº”ç”¨æ›´åƒåŸç”Ÿåº”ç”¨ï¼‰
          echo "æ­£åœ¨åˆ›å»º macOS .app åŒ…..."
          mkdir -p "AutoLogin.app/Contents/MacOS"
          mkdir -p "AutoLogin.app/Contents/Resources"
          
          # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
          cp dist/auto-login "AutoLogin.app/Contents/MacOS/auto-login"
          chmod +x "AutoLogin.app/Contents/MacOS/auto-login"
          
          # åˆ›å»º Info.plist
          cat > "AutoLogin.app/Contents/Info.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>auto-login</string>
              <key>CFBundleIdentifier</key>
              <string>com.autologin.app</string>
              <key>CFBundleName</key>
              <string>AutoLogin</string>
              <key>CFBundleVersion</key>
              <string>1.0</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          echo "âœ… macOS .app åŒ…åˆ›å»ºå®Œæˆ"

      - name: æ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ (Linux)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          echo "æ­£åœ¨æ„å»º Linux å¯æ‰§è¡Œæ–‡ä»¶..."
          pyinstaller --name=auto-login --onefile --console --clean --noconfirm --strip \
            --hidden-import=playwright.sync_api \
            --hidden-import=pytesseract \
            --hidden-import=PIL \
            --hidden-import=config \
            --hidden-import=browser_manager \
            --hidden-import=lock_manager \
            --hidden-import=ocr_engine \
            --exclude-module=matplotlib \
            --exclude-module=numpy \
            --exclude-module=pandas \
            --exclude-module=tkinter \
            main.py
          
          echo "âœ… Linux å¯æ‰§è¡Œæ–‡ä»¶æ„å»ºå®Œæˆ"

      - name: å‡†å¤‡å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          mkdir -p release
          
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            cp dist/auto-login.exe release/${{ matrix.artifact_name }}
            echo "âœ… Windows å¯æ‰§è¡Œæ–‡ä»¶: ${{ matrix.artifact_name }}"
          elif [ "${{ matrix.os }}" == "macos-latest" ]; then
            # å¤åˆ¶å¯æ‰§è¡Œæ–‡ä»¶
            cp dist/auto-login release/${{ matrix.artifact_name }}
            chmod +x release/${{ matrix.artifact_name }}
            # å¤åˆ¶ .app åŒ…ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if [ -d "AutoLogin.app" ]; then
              tar -czf release/auto-login-macos-amd64.app.tar.gz AutoLogin.app
              echo "âœ… macOS .app åŒ…: auto-login-macos-amd64.app.tar.gz"
            fi
            echo "âœ… macOS å¯æ‰§è¡Œæ–‡ä»¶: ${{ matrix.artifact_name }}"
          else
            cp dist/auto-login release/${{ matrix.artifact_name }}
            chmod +x release/${{ matrix.artifact_name }}
            echo "âœ… Linux å¯æ‰§è¡Œæ–‡ä»¶: ${{ matrix.artifact_name }}"
          fi
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶ç¤ºä¾‹å’Œè¯´æ˜
          cp config.json.example release/
          cp README.md release/
          cp QUICKSTART.md release/ 2>/dev/null || true
          
          # åˆ›å»ºä½¿ç”¨è¯´æ˜
          cat > release/ä½¿ç”¨è¯´æ˜.txt << 'EOF'
          ==========================================
          Python è‡ªåŠ¨ç™»å½• - ä½¿ç”¨è¯´æ˜
          ==========================================
          
          Windows ç”¨æˆ·ï¼š
          1. åŒå‡» auto-login-windows-amd64.exe è¿è¡Œ
          2. é¦–æ¬¡è¿è¡Œä¼šè‡ªåŠ¨åˆ›å»º config.json é…ç½®æ–‡ä»¶
          3. ç¼–è¾‘ config.json å¡«å†™è´¦å·å¯†ç 
          4. é‡æ–°è¿è¡Œç¨‹åºå³å¯
          
          macOS ç”¨æˆ·ï¼š
          æ–¹å¼ä¸€ï¼šä½¿ç”¨å¯æ‰§è¡Œæ–‡ä»¶
          1. åœ¨ç»ˆç«¯ä¸­è¿è¡Œï¼š
             chmod +x auto-login-macos-amd64
             ./auto-login-macos-amd64
          
          æ–¹å¼äºŒï¼šä½¿ç”¨ .app åŒ…ï¼ˆæ¨èï¼‰
          1. è§£å‹ auto-login-macos-amd64.app.tar.gz
          2. åŒå‡» AutoLogin.app è¿è¡Œ
          3. å¦‚æœæç¤º"æ— æ³•æ‰“å¼€"ï¼Œè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å…è®¸è¿è¡Œ
          
          Linux ç”¨æˆ·ï¼š
          1. æ·»åŠ æ‰§è¡Œæƒé™ï¼š
             chmod +x auto-login-linux-amd64
          2. è¿è¡Œï¼š
             ./auto-login-linux-amd64
          
          æ³¨æ„äº‹é¡¹ï¼š
          - é¦–æ¬¡è¿è¡Œéœ€è¦å®‰è£… Playwright æµè§ˆå™¨ï¼š
            playwright install chromium
          - éœ€è¦å®‰è£… Tesseract OCRï¼ˆç³»ç»Ÿçº§ä¾èµ–ï¼‰
          - é…ç½®æ–‡ä»¶ config.json ä¸ç¨‹åºåœ¨åŒä¸€ç›®å½•
          
          ==========================================
          EOF
          
          # åˆ›å»ºè‹±æ–‡è¯´æ˜
          cat > release/README_EN.txt << 'EOF'
          ==========================================
          Python Auto Login - Usage Guide
          ==========================================
          
          Windows Users:
          1. Double-click auto-login-windows-amd64.exe to run
          2. Config file config.json will be created on first run
          3. Edit config.json and fill in your credentials
          4. Run the program again
          
          macOS Users:
          Method 1: Use executable
          1. Run in terminal:
             chmod +x auto-login-macos-amd64
             ./auto-login-macos-amd64
          
          Method 2: Use .app bundle (Recommended)
          1. Extract auto-login-macos-amd64.app.tar.gz
          2. Double-click AutoLogin.app to run
          3. If prompted "cannot be opened", allow it in System Settings
          
          Linux Users:
          1. Add execute permission:
             chmod +x auto-login-linux-amd64
          2. Run:
             ./auto-login-linux-amd64
          
          Notes:
          - First run requires Playwright browser:
            playwright install chromium
          - Requires Tesseract OCR (system dependency)
          - Config file config.json is in the same directory as the program
          
          ==========================================
          EOF

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}-${{ matrix.python-version }}
          path: release/
          retention-days: 30

  release:
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    
    steps:
      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        shell: bash
        run: |
          mkdir -p release_package
          
          # å¤åˆ¶æ‰€æœ‰å¯æ‰§è¡Œæ–‡ä»¶
          find artifacts -name "auto-login-*" -type f -exec cp {} release_package/ \;
          find artifacts -name "*.app.tar.gz" -type f -exec cp {} release_package/ \;
          
          # å¤åˆ¶è¯´æ˜æ–‡ä»¶
          find artifacts -name "ä½¿ç”¨è¯´æ˜.txt" -exec cp {} release_package/ \;
          find artifacts -name "README_EN.txt" -exec cp {} release_package/ \;
          find artifacts -name "README.md" -exec head -1 {} > release_package/README.md || true
          find artifacts -name "config.json.example" -exec cp {} release_package/ \;
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯
          echo "ç‰ˆæœ¬: ${{ github.ref_name }}" > release_package/ç‰ˆæœ¬ä¿¡æ¯.txt
          echo "æ„å»ºæ—¶é—´: $(date)" >> release_package/ç‰ˆæœ¬ä¿¡æ¯.txt
          echo "æäº¤: ${{ github.sha }}" >> release_package/ç‰ˆæœ¬ä¿¡æ¯.txt

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_package/**
          generate_release_notes: true
          draft: false
          prerelease: false
          body: |
            ## ğŸ“¦ å¯æ‰§è¡Œæ–‡ä»¶ä¸‹è½½
            
            ### Windows ç”¨æˆ·
            - ä¸‹è½½ `auto-login-windows-amd64.exe`
            - åŒå‡»è¿è¡Œå³å¯
            
            ### macOS ç”¨æˆ·
            - ä¸‹è½½ `auto-login-macos-amd64` æˆ– `auto-login-macos-amd64.app.tar.gz`
            - è§£å‹ .app åŒ…ååŒå‡»è¿è¡Œ
            
            ### Linux ç”¨æˆ·
            - ä¸‹è½½ `auto-login-linux-amd64`
            - æ·»åŠ æ‰§è¡Œæƒé™åè¿è¡Œ
            
            ## ğŸ“ ä½¿ç”¨è¯´æ˜
            è¯·æŸ¥çœ‹ `ä½¿ç”¨è¯´æ˜.txt` æˆ– `README_EN.txt`
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            - é¦–æ¬¡è¿è¡Œéœ€è¦å®‰è£… Playwright æµè§ˆå™¨å’Œ Tesseract OCR
            - è¯¦ç»†å®‰è£…è¯´æ˜è¯·æŸ¥çœ‹ README.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
