name: Build Windows EXE

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Install Playwright Chromium
        run: playwright install chromium
      
      - name: Prepare browser files (optional)
        run: |
          python -c "from playwright.sync_api import sync_playwright; p = sync_playwright().start(); print(p.chromium.executable_path); p.stop()" > browser_path.txt
          $browserPath = Get-Content browser_path.txt -Raw
          $browserPath = $browserPath.Trim()
          $browserDir = Split-Path (Split-Path $browserPath)
          $targetDir = "browser\chromium"
          New-Item -ItemType Directory -Force -Path $targetDir | Out-Null
          $chromeSubDir = Get-ChildItem $browserDir | Where-Object { $_.Name -like "chrome-win*" } | Select-Object -First 1
          if ($chromeSubDir) {
            Copy-Item -Path $chromeSubDir.FullName -Destination "$targetDir\$($chromeSubDir.Name)" -Recurse -Force
            echo "浏览器文件已复制到 $targetDir"
          }
        continue-on-error: true
      
      - name: Build EXE with PyInstaller
        run: |
          pyinstaller --name=auto-login `
            --onefile `
            --console `
            --clean `
            --noconfirm `
            --strip `
            --optimize=2 `
            --hidden-import=playwright.sync_api `
            --hidden-import=playwright._impl._driver `
            --hidden-import=config `
            --hidden-import=browser_manager `
            --hidden-import=lock_manager `
            --exclude-module=matplotlib `
            --exclude-module=numpy `
            --exclude-module=pandas `
            --exclude-module=scipy `
            --exclude-module=tkinter `
            --exclude-module=pytest `
            --exclude-module=unittest `
            --exclude-module=pytesseract `
            --exclude-module=PIL `
            --exclude-module=easyocr `
            --exclude-module=email `
            --exclude-module=http `
            --exclude-module=urllib3 `
            main.py
      
      - name: Calculate file sizes
        run: |
          echo "=== 文件大小分析 ==="
          if (Test-Path "dist\auto-login.exe") {
            $size = (Get-Item "dist\auto-login.exe").Length / 1MB
            echo "auto-login.exe: $([math]::Round($size, 2)) MB"
          }
          if (Test-Path "browser") {
            $size = (Get-ChildItem -Path "browser" -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
            echo "browser/: $([math]::Round($size, 2)) MB"
          }
      
      - name: Upload artifacts (Full version with browser)
        uses: actions/upload-artifact@v4
        with:
          name: Auto-Login-Tool-Python-Full
          path: |
            dist/auto-login.exe
            browser/
            README.md
          if-no-files-found: error
      
      - name: Upload artifacts (Lite version without browser)
        uses: actions/upload-artifact@v4
        with:
          name: Auto-Login-Tool-Python-Lite
          path: |
            dist/auto-login.exe
            README.md
          if-no-files-found: error
